<div class="pedidos-page">
  <p-toast></p-toast>
  <p-confirmDialog header="Confirmação" icon="pi pi-exclamation-triangle" [style]="{width: '400px'}"></p-confirmDialog>

  <h2>Pedidos de Marcação</h2>
  <p>Gestão e acompanhamento de pedidos de marcação</p>

  <!-- Barra de Pesquisa -->
  <div class="search-container">
    <div class="search-field">
      <i class="pi pi-search search-icon"></i>
      <input 
        #searchInput
        pInputText 
        type="text" 
        placeholder="Pesquisar por ID, nome do usuário ou tipo de consulta..." 
        [(ngModel)]="searchTerm"
        (input)="filterPedidos()"
        class="search-input"
      />
      <button 
        *ngIf="searchTerm" 
        type="button" 
        class="clear-search"
        (click)="clearSearch()"
        title="Limpar pesquisa"
      >
        <i class="pi pi-times"></i>
      </button>
    </div>
  </div>

  <!-- Tabela de Pedidos -->
  <table class="pedidos-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Usuário ID</th>
        <th>Data Solicitação</th>
        <th>Período</th>
        <th>Horário</th>
        <th>Estado Atual</th>
        <th>Observações</th>
        <th>Atos Clínicos</th>
        <th>Detalhes</th>
        <th>Editar</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let pedido of filteredPedidos; let i = index">
        <tr [ngClass]="{'notificacao-barra': pedido.solicitacaoCancelamento || pedido.solicitacaoReagendamento}">
          <td>
            <ng-container *ngIf="pedido.solicitacaoCancelamento || pedido.solicitacaoReagendamento">
              <span class="notificacao-indicador" title="Solicitação pendente">
                <i class="pi pi-exclamation-triangle"></i>
              </span>
            </ng-container>
            {{ pedido.id }}
          </td>
          <td>{{ pedido.userId }}</td>
          <td>{{ formatDate(pedido.dataSolicitacao) }}</td>
          <td>{{ formatDate(pedido.dataInicio) }} - {{ formatDate(pedido.dataFim) }}</td>
          <td>{{ pedido.horario }}</td>
          <td>
            <span class="pedido-estado" [ngClass]="'estado-' + pedido.estado.toLowerCase()">
              {{ getEstadoLabel(pedido.estado) }}
            </span>
          </td>
          <td>{{ pedido.observacoes || 'Sem observações' }}</td>
          <td>{{ pedido.actosClinicos.length || 0 }}</td> <!-- Safe navigation with default 0 -->
          <td>
            <button 
              class="action-button" 
              title="Ver Detalhes" 
              (click)="toggleDetalhes(pedido.id)"
            >
              <i class="pi" [ngClass]="expandedPedidos.has(pedido.id) ? 'pi-eye-slash' : 'pi-eye'"></i>
            </button>
          </td>
          <td>
            <button 
              *ngIf="pedido.estado !== 'Realizado' && pedido.estado !== 'Cancelado'" 
              class="action-button edit-button" 
              title="Editar Pedido" 
              (click)="openEditDialog(pedido)"
            >
              <i class="pi pi-pencil"></i>
            </button>
          </td>
        </tr>
        
        <!-- Linha de Detalhes Expandida -->
        <tr *ngIf="expandedPedidos.has(pedido.id)" 
            [ngClass]="{'detalhes-row': true, 'expanded': expandedPedidos.has(pedido.id)}">
          <td colspan="9">
            <div class="detalhes-container">
            
            <!-- Observações -->
            <div *ngIf="pedido.observacoes" class="observacoes-section">
              <h4><i class="pi pi-info-circle"></i> Observações</h4>
              <p>{{ pedido.observacoes }}</p>
            </div>

            <!-- Horário -->
            <div class="observacoes-section">
              <h4><i class="pi pi-clock"></i> Horário</h4>
              <p>{{ pedido.horario }}</p>
            </div>

            <!-- Atos Clínicos -->
            <div class="actos-section">
              <h4><i class="pi pi-calendar-plus"></i> Atos Clínicos ({{ pedido.actosClinicos.length || 0 }})</h4> <!-- Safe navigation -->
              
              <div class="actos-grid">
                <div 
                  *ngFor="let acto of pedido.actosClinicos || []; let j = index" 
                  class="acto-card"
                >
                  <div class="acto-header">
                    <h5>{{ acto?.tipoDeConsultaExame?.nome || 'Sem Nome' }}</h5>
                    <span class="acto-id">#{{ acto?.id }}</span>
                  </div>
                  
                  <div class="acto-details">
                    <div class="detail-item">
                      <i class="pi pi-building"></i>
                      <span>{{ acto?.subsistemaSaude?.nome || 'Sem Subsistema' }}</span>
                    </div>
                    
                    <ng-container *ngIf="acto">
                      <div *ngIf="acto.dataHora" class="detail-item">
                        <i class="pi pi-clock"></i>
                        <span>{{ formatTime(acto.dataHora) }}</span>
                      </div>
                      
                      <div *ngIf="acto.anoMesDia" class="detail-item">
                        <i class="pi pi-calendar"></i>
                        <span>{{ formatDate(acto.anoMesDia) }}</span>
                      </div>
                      
                      <div *ngIf="acto?.profissional" class="detail-item profissionais-item">
                        <i class="pi pi-user"></i>
                        <span class="profissional-tag">
                          {{ acto.profissional?.nome ?? 'Nome não disponível' }}
                          <small *ngIf="acto.profissional?.tipoDeConsultaExameId">{{ acto.profissional?.tipoDeConsultaExameNome }}</small>
                        </span>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </ng-container>
  </tbody>
</table>

<!-- Mensagem quando não há dados -->
<div *ngIf="filteredPedidos.length === 0" class="no-data">
  <i class="pi pi-info-circle"></i>
  <p>{{ searchTerm ? 'Nenhum pedido encontrado para a pesquisa.' : 'Nenhum pedido de marcação encontrado.' }}</p>
</div>
</div>

<!-- Modal de Edição de Pedido -->
<p-dialog 
  header="Editar Pedido de Marcação" 
  [(visible)]="showEditDialog" 
  [modal]="true"
  [style]="{width: '800px'}"
  [draggable]="false"
  [resizable]="false"
  *ngIf="pedidoForm"
>
  <form [formGroup]="pedidoForm" (ngSubmit)="onSubmitEdit()">
    <div *ngIf="pedidoForm.get('solicitacaoCancelamento')?.value || pedidoForm.get('solicitacaoReagendamento')?.value" class="solicitacao-alerta p-mb-3">
      <ng-container *ngIf="pedidoForm.get('solicitacaoCancelamento')?.value">
        <div class="alerta-cancelamento">
          <i class="pi pi-ban"></i> Solicitação de <b>cancelamento</b> pendente para este pedido.
        </div>
      </ng-container>
      <ng-container *ngIf="pedidoForm.get('solicitacaoReagendamento')?.value">
        <div class="alerta-reagendamento">
          <i class="pi pi-calendar-plus"></i> Solicitação de <b>reagendamento</b> pendente.<br>
          <span *ngIf="pedidoForm.get('novoDataInicioSoli')?.value">Nova Data Início: <b>{{ pedidoForm.get('novoDataInicioSoli')?.value | date:'dd/MM/yyyy' }}</b></span><br>
          <span *ngIf="pedidoForm.get('novoDataFimSoli')?.value">Nova Data Fim: <b>{{ pedidoForm.get('novoDataFimSoli')?.value | date:'dd/MM/yyyy' }}</b></span><br>
          <span *ngIf="pedidoForm.get('novoHorarioSoli')?.value">Novo Horário: <b>{{ pedidoForm.get('novoHorarioSoli')?.value }}</b></span>
        </div>
      </ng-container>
    </div>
    <div class="p-fluid p-formgrid p-grid">
      <div class="p-field p-col-12 p-md-6">
        <label>Estado *</label>
        <p-dropdown [options]="estadoOptions" formControlName="estado" optionLabel="label" optionValue="value" placeholder="Selecione" (onChange)="onEstadoChange()"></p-dropdown>
      </div>
      <div class="p-field p-col-12 p-md-6">
        <label>Horário *</label>
        <input pInputText type="time" formControlName="horario" placeholder="HH:MM" min="07:00" max="22:00" />
        <div *ngIf="pedidoForm.get('horario')?.touched && !isHorarioValido(pedidoForm.get('horario')?.value)" class="text-danger">
          <i class="pi pi-exclamation-triangle"></i> O horário deve estar entre 07:00 e 22:00.
        </div>
      </div>
      <div class="p-field p-col-12 p-md-6">
        <label>Observações *</label>
        <textarea pInputTextarea formControlName="observacoes" rows="3" placeholder="Digite as observações do pedido..."></textarea>
      </div>
    </div>
    <div class="p-mt-3">
      <h4>Agendamento dos Atos Clínicos</h4>
      <div *ngIf="pedidoForm.get('estado')?.value === 'Agendado'" class="warning-message p-mb-3">
        <i class="pi pi-exclamation-triangle"></i>
        <span>Para agendar um pedido, todos os atos clínicos devem ter data e hora definidas.</span>
      </div>
      <div formArrayName="actosClinicos">
        <div *ngFor="let acto of actosClinicosFormArray.controls; let i = index" [formGroupName]="i" class="p-grid p-align-center p-mb-2 acto-edit-card">
          <div class="p-field p-col-12 p-md-4">
            <label>Tipo de Consulta/Exame</label>
            <div class="acto-info">
              <strong>{{ getTipoConsultaNome(acto.get('tipoDeConsultaExameId')?.value) }}</strong>
              <br>
              <small>{{ getSubsistemaNome(acto.get('subsistemaSaudeId')?.value) }}</small>
            </div>
          </div>
          <div class="p-field p-col-12 p-md-3">
            <label>Data {{ pedidoForm.get('estado')?.value === 'Agendado' ? '*' : '' }}</label>
            <small class="text-muted d-block mb-1">
              Intervalo permitido:
              {{ pedidoForm.get('dataInicio')?.value | date:'dd/MM/yyyy' }} até
              {{ pedidoForm.get('dataInicio')?.value | date:'dd/MM/yyyy' }}
            </small>
            <p-calendar formControlName="anoMesDia" dateFormat="yy-mm-dd" showIcon="true" placeholder="Selecione a data"></p-calendar>
          </div>
          <div class="p-field p-col-12 p-md-3">
            <label>Hora {{ pedidoForm.get('estado')?.value === 'Agendado' ? '*' : '' }}</label>
            <input pInputText type="time" formControlName="dataHora" placeholder="HH:MM" min="07:00" max="22:00" />
            <div *ngIf="acto.get('dataHora')?.touched && !isHorarioValido(acto.get('dataHora')?.value)" class="text-danger">
              <i class="pi pi-exclamation-triangle"></i> O horário deve estar entre 07:00 e 22:00.
            </div>
          </div>
          <div class="p-field p-col-12 p-md-2">
            <label>Profissional *</label>
            <p-dropdown 
              [options]="profissionaisOptions" 
              formControlName="profissionalId" 
              optionLabel="nome" 
              optionValue="id" 
              placeholder="Selecione o profissional">
            </p-dropdown>
          </div>
        </div>
      </div>
    </div>
    <div class="p-d-flex p-jc-end p-mt-4">
      <ng-container *ngIf="pedidoForm.get('solicitacaoCancelamento')?.value || pedidoForm.get('solicitacaoReagendamento')?.value">
        <button type="button" pButton label="Aceitar Solicitação" class="p-button-success p-mr-2" (click)="onAceitarSolicitacao()"></button>
        <button type="button" pButton label="Recusar Solicitação" class="p-button-danger" (click)="onRecusarSolicitacao()"></button>
      </ng-container>
      <button type="button" pButton label="Cancelar" class="p-button-text" (click)="showEditDialog = false"></button>
      <button type="submit" pButton label="Salvar" [disabled]="pedidoForm.invalid"></button>
    </div>
  </form>
</p-dialog>