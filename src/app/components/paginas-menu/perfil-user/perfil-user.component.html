<p-toast></p-toast>

<app-header></app-header>

<div class="profile-container">
  <!-- Profile Summary Card -->
  <div class="profile-card">
    <div class="profile-header">
      <div class="profile-name">{{ user?.nome || 'Seu Nome' }}</div>
    </div>
    <div class="profile-pic-container">
      <img *ngIf="user?.fotografia" [src]="'https://localhost:7273' + user?.fotografia" alt="Foto de Perfil" class="profile-pic" />
      <i *ngIf="!user?.fotografia" class="pi pi-user profile-icon"></i>
    </div>
    <div class="profile-content">
      <div class="d-flex justify-content-center gap-4 mb-4">
        <div class="text-center">
          <div class="fs-5 fw-bold">{{ marcacoes.length || '0' }}</div>
          <div class="text-muted">Marcaçōes</div>
        </div>
        <div class="text-center">
          <div class="fs-5 fw-bold">{{ getMarcacoesByEstado('APROVADO') + getMarcacoesByEstado('Confirmada') }}</div>
          <div class="text-muted">Confirmadas</div>
        </div>
        <div class="text-center">
          <div class="fs-5 fw-bold">{{ getMarcacoesByEstado('PENDENTE') + getMarcacoesByEstado('Pedido') }}</div>
          <div class="text-muted">Pendentes</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="tab-container">
    <p-tabView>
      <!-- Tab 1: My Data -->
      <p-tabPanel header="Meus Dados">
        <div class="user-details">
          <div *ngIf="isEditing; else viewMode">
            <form (ngSubmit)="onSubmit()" #userForm="ngForm" class="form-container">
              <div class="row">
                <div class="col-md-6">
                  <div class="field">
                    <label for="nome">Nome *</label>
                    <input pInputText id="nome" [(ngModel)]="editUser.nome" name="nome" required class="form-control" placeholder="Seu nome completo" [class.invalid]="!editUser.nome?.trim() && editUser.nome !== ''">
                    <small *ngIf="!editUser.nome?.trim() && editUser.nome !== ''" class="error-message">Nome é obrigatório</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="field">
                    <label for="email">Email *</label>
                    <input pInputText id="email" [(ngModel)]="editUser.email" name="email" required type="email" class="form-control" placeholder="seu.email@exemplo.com" [class.invalid]="!editUser.email?.trim() && editUser.email !== ''">
                    <small *ngIf="!editUser.email?.trim() && editUser.email !== ''" class="error-message">Email é obrigatório</small>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="field">
                    <label for="telemovel">Telemóvel *</label>
                    <input pInputText id="telemovel" [(ngModel)]="editUser.telemovel" name="telemovel" required class="form-control" placeholder="(00) 00000-0000" [class.invalid]="!editUser.telemovel?.trim() && editUser.telemovel !== ''">
                    <small *ngIf="!editUser.telemovel?.trim() && editUser.telemovel !== ''" class="error-message">Telemóvel é obrigatório</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="field">
                    <label for="genero">Gênero</label>
                    <p-dropdown [options]="genders" [(ngModel)]="editUser.genero" name="genero" placeholder="Selecione seu gênero" styleClass="w-full"></p-dropdown>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="field">
                    <label for="dataNascimento">Data de Nascimento</label>
                    <p-calendar id="dataNascimento" [(ngModel)]="editUser.dataNascimento" name="dataNascimento" dateFormat="dd/mm/yy" [showIcon]="true"></p-calendar>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="field">
                    <label for="morada">Morada *</label>
                    <input pInputText id="morada" [(ngModel)]="editUser.morada" name="morada" required class="form-control" placeholder="Sua morada completa" [class.invalid]="!editUser.morada?.trim() && editUser.morada !== ''">
                    <small *ngIf="!editUser.morada?.trim() && editUser.morada !== ''" class="error-message">Morada é obrigatória</small>
                  </div>
                </div>
              </div>
              
              <!-- Seção de Foto de Perfil -->
              <div class="row">
                <div class="col-12">
                  <div class="field">
                    <label>Foto de Perfil</label>
                    <div class="photo-upload-section">
                      <div class="current-photo">
                        <img *ngIf="getCurrentPhotoUrl()" [src]="getCurrentPhotoUrl()" alt="Foto de Perfil" class="profile-photo-preview">
                        <div *ngIf="!getCurrentPhotoUrl()" class="profile-photo-preview profile-icon-placeholder">
                          <i class="pi pi-user"></i>
                        </div>
                      </div>
                      <div class="upload-controls">
                        <input type="file" id="photoUpload" (change)="onFileSelected($event)" accept="image/*" style="display: none;">
                        <button type="button" pButton pRipple label="Selecionar Foto" icon="pi pi-upload" class="p-button-outlined" (click)="openFileSelector()"></button>
                        <button *ngIf="selectedFile" type="button" pButton pRipple label="Remover" icon="pi pi-trash" class="p-button-outlined p-button-danger" (click)="removeSelectedFile()"></button>
                      </div>
                      <small class="text-muted">Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 5MB</small>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="button-group">
                <button pButton pRipple type="button" label="Cancelar" (click)="cancelEdit()" class="p-button-outlined p-button-secondary" [disabled]="saving"></button>
                <button pButton pRipple type="submit" label="Salvar Alterações" class="p-button-primary" [disabled]="saving">
                  <i *ngIf="saving" class="pi pi-spin pi-spinner" style="margin-right: 8px;"></i>
                  {{ saving ? 'Salvando...' : 'Salvar Alterações' }}
                </button>
                <div *ngIf="hasChanges() && !saving" class="changes-indicator">
                  <i class="pi pi-exclamation-triangle"></i>
                  <span>Alterações não salvas</span>
                </div>
              </div>
            </form>
          </div>
          
          <ng-template #viewMode>
            <div>
              <p>
                <strong>Nome:</strong> 
                <span>{{ user?.nome }}</span>
              </p>
              <p>
                <strong>Email:</strong> 
                <span>{{ user?.email }}</span>
              </p>
              <p>
                <strong>Telemóvel:</strong> 
                <span>{{ user?.telemovel }}</span>
              </p>
              <p>
                <strong>Morada:</strong> 
                <span>{{ user?.morada }}</span>
              </p>
              <p>
                <strong>Data de Nascimento:</strong> 
                <span>{{ user?.dataNascimento | date:'dd/MM/yyyy' }}</span>
              </p>
              <p>
                <strong>Gênero:</strong> 
                <span>{{ user?.genero }}</span>
              </p>
              
              <div class="button-group">
                <button pButton pRipple label="Editar Perfil" (click)="toggleEdit()" class="p-button-primary"></button>
                <button pButton pRipple label="Alterar Senha" (click)="togglePasswordChange()" class="p-button-outlined p-button-warning"></button>
              </div>
            </div>
          </ng-template>
        </div>

        <!-- Seção de Alteração de Senha -->
        <div *ngIf="isChangingPassword" class="password-change-section">
          <h4><i class="pi pi-lock"></i> Alterar Senha</h4>
          <form (ngSubmit)="onSubmitPassword()" #passwordForm="ngForm" class="password-form">
            <div class="row">
              <div class="col-md-6">
                <div class="field">
                  <label for="currentPassword">Senha Atual *</label>
                  <p-password id="currentPassword" [(ngModel)]="passwordData.currentPassword" name="currentPassword" 
                    [feedback]="false" [toggleMask]="true" placeholder="Digite sua senha atual" 
                    [class.invalid]="!passwordData.currentPassword.trim() && passwordData.currentPassword !== ''">
                  </p-password>
                  <small *ngIf="!passwordData.currentPassword?.trim() && passwordData.currentPassword !== ''" class="error-message">Senha atual é obrigatória</small>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="field">
                  <label for="newPassword">Nova Senha *</label>
                  <p-password id="newPassword" [(ngModel)]="passwordData.newPassword" name="newPassword" 
                    [feedback]="true" [toggleMask]="true" placeholder="Digite a nova senha"
                    [class.invalid]="passwordData.newPassword && passwordData.newPassword.length < 6">
                  </p-password>
                  <small *ngIf="passwordData.newPassword && passwordData.newPassword.length < 6" class="error-message">Senha deve ter pelo menos 6 caracteres</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="field">
                  <label for="confirmPassword">Confirmar Nova Senha *</label>
                  <p-password id="confirmPassword" [(ngModel)]="passwordData.confirmPassword" name="confirmPassword" 
                    [feedback]="false" [toggleMask]="true" placeholder="Confirme a nova senha"
                    [class.invalid]="passwordData.confirmPassword && passwordData.newPassword !== passwordData.confirmPassword">
                  </p-password>
                  <small *ngIf="passwordData.confirmPassword && passwordData.newPassword !== passwordData.confirmPassword" class="error-message">Senhas não conferem</small>
                </div>
              </div>
            </div>
            
            <div class="button-group">
              <button pButton pRipple type="button" label="Cancelar" (click)="cancelPasswordChange()" class="p-button-outlined p-button-secondary" [disabled]="changingPassword"></button>
              <button pButton pRipple type="submit" label="Alterar Senha" class="p-button-warning" [disabled]="changingPassword">
                <i *ngIf="changingPassword" class="pi pi-spin pi-spinner" style="margin-right: 8px;"></i>
                {{ changingPassword ? 'Alterando...' : 'Alterar Senha' }}
              </button>
            </div>
          </form>
        </div>
      </p-tabPanel>

      <!-- Tab 2: My Appointments -->
      <p-tabPanel header="Minhas Marcações">
        <div class="appointments-card">
          <div class="appointment-header">
            <h3>Minhas Marcações</h3>
            <button pButton pRipple label="Nova Marcação" class="p-button-outlined p-button-help" (click)="newAppointment()"></button>
          </div>
          
          <!-- Loading State -->
          <div *ngIf="loading" class="text-center py-5">
            <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: #3b82f6;"></i>
            <p class="mt-3">Carregando marcações...</p>
          </div>
          
          <!-- Appointment Cards -->
          <div *ngFor="let marcacao of marcacoes" class="appointment-card">
            <div class="appointment-card-header" (click)="toggleAppointmentDetails(marcacao)">
              <div>
                <h4 class="mb-1">Pedido #{{ marcacao.id }}</h4>
                <div class="d-flex align-items-center gap-3">
                  <div><i class="pi pi-calendar"></i> {{ formatDate(marcacao.dataInicio) }} - {{ formatDate(marcacao.dataFim) }}</div>
                  <div><i class="pi pi-clock"></i> {{ formatDateTime(marcacao.dataSolicitacao) }}</div>
                </div>
              </div>
              <div>
                <span class="status-badge" [ngClass]="getEstadoClass(marcacao.estado)">
                  {{ getEstadoLabel(marcacao.estado) }}
                </span>
              </div>
            </div>
            
            <div class="appointment-card-body" *ngIf="isAppointmentExpanded(marcacao)">
              <!-- Observações -->
              <div *ngIf="marcacao.observacoes" class="observacoes-section">
                <h5><i class="pi pi-info-circle"></i> Observações</h5>
                <p>{{ marcacao.observacoes }}</p>
              </div>
              
              <!-- Actos Clínicos -->
              <div class="actos-section">
                <h5><i class="pi pi-calendar-plus"></i> Actos Clínicos ({{ marcacao.actosClinicos.length || 0 }})</h5>
                
                <div class="actos-grid">
                  <div *ngFor="let acto of marcacao.actosClinicos" class="acto-card">
                    <div class="acto-header">
                      <h6>{{ acto.tipoDeConsultaExame?.nome || 'Sem Nome' }}</h6>
                      <span class="acto-id">#{{ acto.id }}</span>
                    </div>
                    
                    <div class="acto-details">
                      <div class="detail-item">
                        <i class="pi pi-building"></i>
                        <span>{{ acto.subsistemaSaude?.nome || 'Sem Subsistema' }}</span>
                      </div>
                      <div class="detail-item">
                        <i class="pi pi-calendar"></i>
                        <span>{{ acto.anoMesDia ? acto.anoMesDia : 'Por Definir' }}</span>
                      </div>
                      <div class="detail-item">
                        <i class="pi pi-clock"></i>
                        <span>{{ acto.dataHora ? formatTimeOrDateTime(acto.dataHora) : 'Por Definir' }}</span>
                      </div>
                      <div *ngIf="acto.profissional" class="detail-item profissionais-item">
                        <i class="pi pi-user"></i>
                        <span class="profissional-tag">
                          {{ acto.profissional.nome || 'Nome não disponível' }}
                          <small *ngIf="acto.profissional.tipoDeConsultaExameId">{{ acto.profissional.tipoDeConsultaExameNome }}</small>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="d-flex gap-2 mt-4">
                <button pButton pRipple label="Cancelar" class="p-button-outlined p-button-danger"
                  *ngIf="marcacao.estado !== 'CANCELADO' && marcacao.estado !== 'Cancelada' && marcacao.estado !== 'Realizado' && marcacao.estado !== 'REALIZADO' && marcacao.estado !== 'Realizada' && marcacao.estado !== 'REALIZADA' && marcacao.estado !== 'Pedido Realizado'"
                  (click)="solicitarCancelamento(marcacao)" [disabled]="cancelando"></button>
                <button pButton pRipple label="Reagendar" class="p-button-outlined p-button-primary"
                  *ngIf="(marcacao.estado === 'Agendado' || marcacao.estado === 'AGENDADO' || marcacao.estado === 'Pedido' || marcacao.estado === 'PEDIDO')"
                  (click)="openReagendarDialog(marcacao)"></button>
                <button pButton pRipple label="Detalhes" class="p-button-outlined p-button-secondary"></button>
                <button pButton pRipple label="Baixar PDF" class="p-button-success" (click)="gerarPdfMarcacao(marcacao)"></button>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="!loading && (!marcacoes || marcacoes.length === 0)" class="text-center py-5">
            <i class="pi pi-calendar" style="font-size: 3rem; color: #ced4da;"></i>
            <h4 class="mt-3">Nenhuma marcação encontrada</h4>
            <p class="text-muted">Você ainda não possui marcações agendadas</p>
            <button pButton pRipple label="Agendar Consulta" class="p-button-primary mt-3"></button>
          </div>
        </div>
      </p-tabPanel>
    </p-tabView>
  </div>
</div>

<app-footer></app-footer>

<!-- Diálogo de Reagendamento -->
<p-dialog header="Solicitar Reagendamento" [(visible)]="showReagendarDialog" [modal]="true" [style]="{width: '400px'}" (onHide)="closeReagendarDialog()">
  <div class="p-fluid">
    <div class="field">
      <label for="novoDataInicioSoli">Nova Data de Início</label>
      <input id="novoDataInicioSoli" type="date" pInputText [(ngModel)]="novoDataInicioSoli" />
    </div>
    <div class="field">
      <label for="novoDataFimSoli">Nova Data de Fim</label>
      <input id="novoDataFimSoli" type="date" pInputText [(ngModel)]="novoDataFimSoli" />
    </div>
    <div class="field">
      <label for="novoHorarioSoli">Novo Horário</label>
      <input id="novoHorarioSoli" type="time" pInputText [(ngModel)]="novoHorarioSoli" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <button pButton pRipple label="Cancelar" class="p-button-text" (click)="closeReagendarDialog()"></button>
    <button pButton pRipple label="Solicitar Reagendamento" class="p-button-success" (click)="solicitarReagendamento()" [disabled]="reagendando"></button>
  </ng-template>
</p-dialog>